<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>üëµ HoosierHelper ‚Äì Your Kitchen Friend</title>
    <link rel="stylesheet" href="/static/styles.css" />
    <style>
        /* Vegetarian Checkbox Modern, Large, and Elder-Friendly */
        .veg-checkbox-row {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 25px;
        }

        .veg-checkbox-row label {
            font-size: 1.4em;
            font-weight: 600;
            background: #eaf4e8;
            padding: 12px 30px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            box-shadow: 0 1px 10px rgba(85, 120, 65, 0.07);
            border: 2px solid #d4e2d4;
            gap: 14px;
        }

        .veg-checkbox-row input[type="checkbox"] {
            width: 28px;
            height: 28px;
            accent-color: #4caf50;
            margin-right: 10px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div class="grid-container">
        <header>
            <h1>üëµ HoosierHelper ‚Äì Your Kitchen Friend</h1>
            <h2>Find Recipes from Ingredients</h2>
        </header>

        <nav>
            <h3>Menu</h3>
            <ul>
                <li><a href="index.html" class="active">Find Recipes from Ingredients</a></li>
                <li><a href="measurement.html">Measurement Conversions</a></li>
                <li><a href="temperature.html">Cooking Temperatures</a></li>
            </ul>
        </nav>

        <main>
            <!-- Vegetarian Checkbox on top, big and centered -->
            <div class="veg-checkbox-row">
                <label for="vegetarian">
                    <input type="checkbox" id="vegetarian" name="vegetarian" />
                    <span>Vegetarian (meat-free)</span>
                </label>
            </div>

            <p><strong>Step 1:</strong> Choose 1 or more photos of food ingredients or type your ingredients below.</p>
            <p><strong>Step 2:</strong> Press "Generate Recipe" and we'll help you cook!</p>

            <form id="upload-form" enctype="multipart/form-data">
                <input type="file" name="images" accept="image/*" multiple />
                <br />

                <label for="manual_ingredients">Or type ingredients here (comma separated):</label><br />
                <textarea id="manual_ingredients" name="manual_ingredients" rows="3"
                    placeholder="e.g., chicken, tomatoes, garlic"></textarea>
                <br />

                <button type="submit">Generate Recipe</button>
            </form>

            <div class="preview" id="preview"></div>
            <div id="output"></div>

            <div id="controls">
                <button id="prev-btn">‚¨ÖÔ∏è Previous Step</button>
                <button id="pause-btn">‚è∏ Pause</button>
                <button id="resume-btn">‚ñ∂Ô∏è Resume</button>
                <button id="next-btn">Next Step ‚û°Ô∏è</button>
            </div>
        </main>
    </div>

    <script>
        const previewDiv = document.getElementById("preview");
        const output = document.getElementById("output");

        const prevBtn = document.getElementById("prev-btn");
        const nextBtn = document.getElementById("next-btn");
        const pauseBtn = document.getElementById("pause-btn");
        const resumeBtn = document.getElementById("resume-btn");

        let steps = [];
        let currentStepIndex = 0;
        let utterance = null;

        function speak(text) {
            if (window.speechSynthesis.speaking) {
                window.speechSynthesis.cancel();
            }
            utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = "en-US";
            utterance.rate = 0.9;
            window.speechSynthesis.speak(utterance);
        }

        function updateControlsVisibility(show) {
            if (show) {
                prevBtn.style.display = "inline-block";
                nextBtn.style.display = "inline-block";
                pauseBtn.style.display = "inline-block";
                resumeBtn.style.display = "inline-block";
            } else {
                prevBtn.style.display = "none";
                nextBtn.style.display = "none";
                pauseBtn.style.display = "none";
                resumeBtn.style.display = "none";
            }
        }

        window.onload = () => {
            speak("Welcome to Hoosier Helper. Please upload food photos or type ingredients to get your easy recipe.");
            updateControlsVisibility(false);
        };

        document.querySelector('input[name="images"]').addEventListener("change", function (event) {
            previewDiv.innerHTML = "";
            const files = Array.from(event.target.files);
            if (files.length > 0) {
                speak(`You selected ${files.length} image${files.length > 1 ? "s" : ""}.`);
                files.forEach((file) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = document.createElement("img");
                        img.src = e.target.result;
                        previewDiv.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                });
            }
        });

        document.getElementById("upload-form").onsubmit = async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);

            // Check if user provided either images or manual ingredients
            const images = formData.getAll('images').filter(f => f.size > 0);
            const manualIngredients = formData.get('manual_ingredients').trim();

            if (images.length === 0 && manualIngredients === "") {
                output.innerHTML = `<p class="error">‚ö†Ô∏è Please upload images or type ingredients before submitting.</p>`;
                speak("Please upload images or type ingredients before submitting.");
                return;
            }

            output.textContent = "‚è≥ Analyzing your ingredients and writing a recipe... please wait.";
            speak("Analyzing your ingredients. Please wait.");
            updateControlsVisibility(false);

            try {
                const res = await fetch("/upload", {
                    method: "POST",
                    body: formData,
                });

                const data = await res.json();
                output.innerHTML = "";

                if (data.error) {
                    output.innerHTML = `<p class="error">‚ö†Ô∏è ${data.error}</p>`;
                    speak("Sorry, we could not detect any ingredients. Please try again.");
                    updateControlsVisibility(false);
                } else {
                    const formattedOutput =
                        `üìù Ingredients Detected:
${data.ingredients.join(", ")}

üë©‚Äçüç≥ Your Simple Recipe:
${data.recipe}`;

                    output.innerHTML = `<pre>${formattedOutput}</pre>`;

                    steps = data.recipe
                        .split(/\n+/)
                        .map(s => s.trim())
                        .filter(s => s.length > 0);

                    currentStepIndex = 0;
                    speak(steps[currentStepIndex]);
                    updateControlsVisibility(true);
                }
            } catch (err) {
                output.innerHTML = `<p class="error">Something went wrong. Please try again.</p>`;
                speak("Something went wrong. Please try again.");
                updateControlsVisibility(false);
            }
        };

        prevBtn.onclick = () => {
            if (currentStepIndex > 0) {
                currentStepIndex--;
                speak(steps[currentStepIndex]);
            }
        };

        nextBtn.onclick = () => {
            if (currentStepIndex < steps.length - 1) {
                currentStepIndex++;
                speak(steps[currentStepIndex]);
            }
        };

        pauseBtn.onclick = () => {
            if (window.speechSynthesis.speaking) {
                window.speechSynthesis.pause();
            }
        };

        resumeBtn.onclick = () => {
            if (window.speechSynthesis.paused) {
                window.speechSynthesis.resume();
            }
        };
    </script>
</body>

</html>